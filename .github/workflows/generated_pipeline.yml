name: AI DevOps CI/CD Pipeline

on:
  push:
    branches:
      - main
    # üö´ Prevent infinite loop when GitHub Actions pushes commits
    paths-ignore:
      - 'ai/deployment_history.csv'
      - 'ai/deployment_model.pkl'

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install AI Dependencies
      - name: Install AI Requirements
        run: |
          pip install --upgrade pip
          pip install -r ai/requirements.txt

      # 4Ô∏è‚É£ Calculate Git Change Metrics
      - name: Extract Deployment Features
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            LINES_CHANGED=$(git diff --shortstat HEAD~1 | awk '{print $4}')
            FILES_CHANGED=$(git diff --name-only HEAD~1 | wc -l)
          else
            LINES_CHANGED=0
            FILES_CHANGED=0
          fi

          COMMIT_MESSAGE_LENGTH=$(git log -1 --pretty=%B | wc -m)

          if [ "$LINES_CHANGED" -eq 0 ]; then
            CHURN_RATE=0
          else
            CHURN_RATE=$(echo "$FILES_CHANGED $LINES_CHANGED" | awk '{print $1/$2}')
          fi

          echo "LINES_CHANGED=${LINES_CHANGED:-0}" >> $GITHUB_ENV
          echo "FILES_CHANGED=${FILES_CHANGED:-0}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE_LENGTH=${COMMIT_MESSAGE_LENGTH:-0}" >> $GITHUB_ENV
          echo "CHURN_RATE=${CHURN_RATE:-0}" >> $GITHUB_ENV

      # 5Ô∏è‚É£ AI Risk Evaluation
      - name: AI Risk Prediction
        run: |
          RISK=$(python ai/risk_model.py \
            $LINES_CHANGED \
            $FILES_CHANGED \
            $COMMIT_MESSAGE_LENGTH \
            $CHURN_RATE)

          echo "Predicted Risk: $RISK"
          echo "RISK_SCORE=$RISK" >> $GITHUB_ENV

          if (( $(echo "$RISK > 0.7" | bc -l) )); then
            echo "High risk deployment. Stopping pipeline."
          fi

      # 6Ô∏è‚É£ Train Model
      - name: Train ML Model
        run: |
          python ai/train_model.py

      # 7Ô∏è‚É£ Login to Azure Container Registry
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: venudadiprojectacr001.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 8Ô∏è‚É£ Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }} .
          docker tag venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }} venudadiprojectacr001.azurecr.io/ai-devops:latest

      # 9Ô∏è‚É£ Push Docker Image
      - name: Push Docker Image
        run: |
          docker push venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }}
          docker push venudadiprojectacr001.azurecr.io/ai-devops:latest

      # üîü Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Update Azure Web App
      - name: Update Azure Web App
        run: |
          az webapp config container set \
            --name tf-ai-devops-app \
            --resource-group ai-devops-rg \
            --container-image-name venudadiprojectacr001.azurecr.io/ai-devops:latest \
            --container-registry-url https://venudadiprojectacr001.azurecr.io \
            --container-registry-user ${{ secrets.ACR_USERNAME }} \
            --container-registry-password ${{ secrets.ACR_PASSWORD }}

      # 1Ô∏è‚É£2Ô∏è‚É£ Restart Azure Web App
      - name: Restart Web App
        run: |
          az webapp restart \
            --name tf-ai-devops-app \
            --resource-group ai-devops-rg

      # 1Ô∏è‚É£3Ô∏è‚É£ Log Deployment Outcome
      - name: Log Deployment Outcome
        run: |
          python ai/deployment_logger.py \
            $LINES_CHANGED \
            $FILES_CHANGED \
            $COMMIT_MESSAGE_LENGTH \
            $CHURN_RATE \
            0

      # 1Ô∏è‚É£4Ô∏è‚É£ Commit Updated Dataset (SAFE)
      - name: Commit Updated Dataset
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add ai/deployment_history.csv || true
          git add ai/deployment_model.pkl || true
          git commit -m "Auto-update deployment dataset" || echo "No changes to commit"

          git pull --rebase origin main
          git push

