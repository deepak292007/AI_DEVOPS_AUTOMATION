name: AI DevOps CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'ai/deployment_history.csv'
      - 'ai/deployment_model.pkl'

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:

      # 1 Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2 Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3 Install AI Dependencies
      - name: Install AI Requirements
        run: |
          pip install --upgrade pip
          pip install -r ai/requirements.txt

      # 4 Extract Git Metrics
      - name: Extract Deployment Features
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            LINES_CHANGED=$(git diff --shortstat HEAD~1 | awk '{print $4}')
            FILES_CHANGED=$(git diff --name-only HEAD~1 | wc -l)
          else
            LINES_CHANGED=0
            FILES_CHANGED=0
          fi

          COMMIT_MESSAGE_LENGTH=$(git log -1 --pretty=%B | wc -m)

          if [ "$LINES_CHANGED" -eq 0 ]; then
            CHURN_RATE=0
          else
            CHURN_RATE=$(echo "$FILES_CHANGED $LINES_CHANGED" | awk '{print $1/$2}')
          fi

          echo "LINES_CHANGED=${LINES_CHANGED:-0}" >> $GITHUB_ENV
          echo "FILES_CHANGED=${FILES_CHANGED:-0}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE_LENGTH=${COMMIT_MESSAGE_LENGTH:-0}" >> $GITHUB_ENV
          echo "CHURN_RATE=${CHURN_RATE:-0}" >> $GITHUB_ENV

      # 5 AI Risk Prediction
      - name: AI Risk Prediction
        id: risk_step
        run: |
          RISK=$(python ai/risk_model.py \
            $LINES_CHANGED \
            $FILES_CHANGED \
            $COMMIT_MESSAGE_LENGTH \
            $CHURN_RATE)

          echo "Predicted Risk: $RISK"
          echo "RISK_SCORE=$RISK" >> $GITHUB_ENV

          if (( $(echo "$RISK > 0.7" | bc -l) )); then
            echo "BLOCK_DEPLOYMENT=true" >> $GITHUB_ENV
          else
            echo "BLOCK_DEPLOYMENT=false" >> $GITHUB_ENV
          fi

      # 6 Train Model
      - name: Train ML Model
        run: |
          python ai/train_model.py

      # 7 Stop Pipeline If High Risk
      - name: Stop If High Risk
        if: env.BLOCK_DEPLOYMENT == 'true'
        run: |
          echo "High risk deployment detected. Logging failure and stopping."
          python ai/deployment_logger.py \
            $LINES_CHANGED \
            $FILES_CHANGED \
            $COMMIT_MESSAGE_LENGTH \
            $CHURN_RATE \
            1
          exit 1

      # 8 Login to ACR
      - name: Login to ACR
        if: env.BLOCK_DEPLOYMENT == 'false'
        uses: docker/login-action@v3
        with:
          registry: venudadiprojectacr001.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 9 Build Docker Image
      - name: Build Docker Image
        if: env.BLOCK_DEPLOYMENT == 'false'
        run: |
          docker build -t venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }} .
          docker tag venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }} venudadiprojectacr001.azurecr.io/ai-devops:latest

      # 10 Push Docker Image
      - name: Push Docker Image
        if: env.BLOCK_DEPLOYMENT == 'false'
        run: |
          docker push venudadiprojectacr001.azurecr.io/ai-devops:${{ github.run_number }}
          docker push venudadiprojectacr001.azurecr.io/ai-devops:latest

      # 11 Azure Login
      - name: Azure Login
        if: env.BLOCK_DEPLOYMENT == 'false'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 12 Update Azure Web App
      - name: Update Azure Web App
        if: env.BLOCK_DEPLOYMENT == 'false'
        run: |
          az webapp config container set \
            --name tf-ai-devops-app \
            --resource-group ai-devops-rg \
            --container-image-name venudadiprojectacr001.azurecr.io/ai-devops:latest \
            --container-registry-url https://venudadiprojectacr001.azurecr.io \
            --container-registry-user ${{ secrets.ACR_USERNAME }} \
            --container-registry-password ${{ secrets.ACR_PASSWORD }}

      # 13 Restart Web App
      - name: Restart Web App
        if: env.BLOCK_DEPLOYMENT == 'false'
        run: |
          az webapp restart \
            --name tf-ai-devops-app \
            --resource-group ai-devops-rg

      # 14 Log Successful Deployment
      - name: Log Successful Deployment
        if: env.BLOCK_DEPLOYMENT == 'false'
        run: |
          python ai/deployment_logger.py \
            $LINES_CHANGED \
            $FILES_CHANGED \
            $COMMIT_MESSAGE_LENGTH \
            $CHURN_RATE \
            0

      # 15 Commit Updated Dataset
      - name: Commit Updated Dataset
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add ai/deployment_history.csv || true
          git add ai/deployment_model.pkl || true
          git commit -m "Auto-update deployment dataset" || echo "No changes to commit"

          git pull --rebase origin main
          git push
